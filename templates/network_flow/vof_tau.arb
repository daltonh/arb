
# create cell centred stress that represents stress acting across vof interface
<<dim1comment>>CELL_CONSTANT <phi_normal_c[l=1]> "celldivgrad[l=1](<phi_f>)" ON <fluid_mask> output
<<dim2comment>>CELL_CONSTANT <phi_normal_c[l=2]> "celldivgrad[l=2](<phi_f>)" ON <fluid_mask>
<<dim3comment>>CELL_CONSTANT <phi_normal_c[l=3]> "celldivgrad[l=3](<phi_f>)" ON <fluid_mask>
CELL_CONSTANT <phi_normal_c_mag> "sqrt(cellmax(dot(<phi_normal_c[l=:]>,<phi_normal_c[l=:]>),<tinyish>))" ON <fluid_mask> output
CELL_CONSTANT <vof_stress_mask_indicator> "cellif(<phi_normal_c_mag>-<phi_tol>/<celldxmin>,1.d0,0.d0)" ON <fluid_mask> output
CELL_CONSTANT_REGION <vof_stress_mask> "variable(<vof_stress_mask_indicator>)" ON <fluid_mask>

# estimate of the distance between cell averaged velocity and interface
# use this string to choose between the two methods
GENERAL_REPLACEMENTS DEFAULT "<<vofbasedstresslcomment>>" W ""
NONE_CONSTANT <vof_stress_l_constant> 4.d0
# simple, based on phi and celldxmin
CELL_CONSTANT <vof_stress_l> "<phi_c>*<celldxmin>/<vof_stress_l_constant>" ON <vof_stress_mask> output
# more accurate, taking into account interface orientation, but requiring normals throughout <vof_stress_mask>
<<vofbasedstresslcomment>>CELL_LOCAL <vof_d_stress> "cellvofd[best](phi=<phi_c>,normal[l=1]=<phi_normal_c[l=1]>/<phi_normal_c_mag>,normal[l=2]=<phi_normal_c[l=2]>/<phi_normal_c_mag>,normal[l=3]=<phi_normal_c[l=3]>/<phi_normal_c_mag>,phitol=<phi_tol>)" ON <vof_stress_mask> nooutput
#<<vofbasedstresslcomment>>CELL_LOCAL <vof_d_stress_full> "cellvofd[best](phi=<phi_tol>*1.d-1,normal[l=1]=<phi_normal_c[l=1]>/<phi_normal_c_mag>,normal[l=2]=<phi_normal_c[l=2]>/<phi_normal_c_mag>,normal[l=3]=<phi_normal_c[l=3]>/<phi_normal_c_mag>,phitol=<phi_tol>*1.d-2)" ON <vof_stress_mask> nooutput
<<vofbasedstresslcomment>>CELL_LOCAL <vof_d_stress_full> "cellvofd[linearone](phi=0.d0,normal[l=1]=<phi_normal_c[l=1]>/<phi_normal_c_mag>,normal[l=2]=<phi_normal_c[l=2]>/<phi_normal_c_mag>,normal[l=3]=<phi_normal_c[l=3]>/<phi_normal_c_mag>,phitol=-1.d0)" ON <vof_stress_mask> nooutput # giving a negative phitol forces the tolerance to be ignored, and linearone will pull out the extreme d safely
<<vofbasedstresslcomment>>CELL_CONSTANT <vof_stress_l> "(<vof_d_stress_full>-<vof_d_stress>)/<vof_stress_l_constant>" ON <vof_stress_mask> output

<<dim1comment>>               CELL_DERIVED <ugrad_vof_c[l=1,1]> "<phi_normal_c[l=1]>*<u[l=1]>/(<vof_stress_l>*<phi_normal_c_mag>)" ON <vof_stress_mask>
<<dim1comment>><<dim2comment>>CELL_DERIVED <ugrad_vof_c[l=1,2]> "<phi_normal_c[l=1]>*<u[l=2]>/(<vof_stress_l>*<phi_normal_c_mag>)" ON <vof_stress_mask>
<<dim1comment>><<dim3comment>>CELL_DERIVED <ugrad_vof_c[l=1,3]> "<phi_normal_c[l=1]>*<u[l=3]>/(<vof_stress_l>*<phi_normal_c_mag>)" ON <vof_stress_mask>
<<dim2comment>><<dim1comment>>CELL_DERIVED <ugrad_vof_c[l=2,1]> "<phi_normal_c[l=2]>*<u[l=1]>/(<vof_stress_l>*<phi_normal_c_mag>)" ON <vof_stress_mask>
<<dim2comment>>               CELL_DERIVED <ugrad_vof_c[l=2,2]> "<phi_normal_c[l=2]>*<u[l=2]>/(<vof_stress_l>*<phi_normal_c_mag>)" ON <vof_stress_mask>
<<dim2comment>><<dim3comment>>CELL_DERIVED <ugrad_vof_c[l=2,3]> "<phi_normal_c[l=2]>*<u[l=3]>/(<vof_stress_l>*<phi_normal_c_mag>)" ON <vof_stress_mask>
<<dim3comment>><<dim1comment>>CELL_DERIVED <ugrad_vof_c[l=3,1]> "<phi_normal_c[l=3]>*<u[l=1]>/(<vof_stress_l>*<phi_normal_c_mag>)" ON <vof_stress_mask>
<<dim3comment>><<dim2comment>>CELL_DERIVED <ugrad_vof_c[l=3,2]> "<phi_normal_c[l=3]>*<u[l=2]>/(<vof_stress_l>*<phi_normal_c_mag>)" ON <vof_stress_mask>
<<dim3comment>>               CELL_DERIVED <ugrad_vof_c[l=3,3]> "<phi_normal_c[l=3]>*<u[l=3]>/(<vof_stress_l>*<phi_normal_c_mag>)" ON <vof_stress_mask>

<<dim1comment>>CELL_LOCAL <tau_vof_c[l=1,1]> "-<mu>*2.d0*<ugrad_vof_c[l=1,1]>" ON <vof_stress_mask> componentoutput,output
<<dim2comment>>CELL_LOCAL <tau_vof_c[l=2,2]> "-<mu>*2.d0*<ugrad_vof_c[l=2,2]>" ON <vof_stress_mask>
<<dim3comment>>CELL_LOCAL <tau_vof_c[l=3,3]> "-<mu>*2.d0*<ugrad_vof_c[l=3,3]>" ON <vof_stress_mask>
<<dim1comment>><<dim2comment>>CELL_LOCAL <tau_vof_c[l=1,2]> "-<mu>*(<ugrad_vof_c[l=1,2]>+<ugrad_vof_c[l=2,1]>)" ON <vof_stress_mask>
<<dim1comment>><<dim3comment>>CELL_LOCAL <tau_vof_c[l=1,3]> "-<mu>*(<ugrad_vof_c[l=1,3]>+<ugrad_vof_c[l=3,1]>)" ON <vof_stress_mask>
<<dim2comment>><<dim3comment>>CELL_LOCAL <tau_vof_c[l=2,3]> "-<mu>*(<ugrad_vof_c[l=2,3]>+<ugrad_vof_c[l=3,2]>)" ON <vof_stress_mask>
<<dim2comment>><<dim1comment>>CELL_LOCAL <tau_vof_c[l=2,1]> "<tau_vof_c[l=1,2]>" ON <vof_stress_mask>
<<dim3comment>><<dim1comment>>CELL_LOCAL <tau_vof_c[l=3,1]> "<tau_vof_c[l=1,3]>" ON <vof_stress_mask>
<<dim3comment>><<dim2comment>>CELL_LOCAL <tau_vof_c[l=3,2]> "<tau_vof_c[l=2,3]>" ON <vof_stress_mask>
