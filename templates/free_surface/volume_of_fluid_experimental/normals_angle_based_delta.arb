INCLUDE "delta"

# calculate the cell centred unit normals at the current timestep, to be used in both the curvature and advection calculations
<<dim1comment>>CELL_LOCAL <vof_phigrad[l=1]> "<vof_delta[l=1]>" ON <all cells> output
<<dim2comment>>CELL_LOCAL <vof_phigrad[l=2]> "<vof_delta[l=2]>" ON <all cells>
<<dim3comment>>CELL_LOCAL <vof_phigrad[l=3]> "<vof_delta[l=3]>" ON <all cells>
CELL_DERIVED <vof_phigrad_mag> "<vof_delta_mag>" ON <all cells>
<<dim1comment>>CELL_DERIVED <vof_phigrad_unit[l=1]> "cellif(<vof_delta_mask>,<vof_delta[l=1]>/<vof_delta_mag>,0.d0)" ON <all cells> output
<<dim2comment>>CELL_DERIVED <vof_phigrad_unit[l=2]> "cellif(<vof_delta_mask>,<vof_delta[l=2]>/<vof_delta_mag>,0.d0)" ON <all cells>
<<dim3comment>>CELL_DERIVED <vof_phigrad_unit[l=3]> "cellif(<vof_delta_mask>,<vof_delta[l=3]>/<vof_delta_mag>,0.d0)" ON <all cells>

# calculate the cell centred unit normals at the current timestep, to be used in both the curvature and advection calculations
#<<dim1comment>>CELL_LOCAL <vof_phigrad[l=1]> "cellgrad[l=1](<vof_phi_lim>)" ON <all cells> output
#<<dim2comment>>CELL_LOCAL <vof_phigrad[l=2]> "cellgrad[l=2](<vof_phi_lim>)" ON <all cells>
#<<dim3comment>>CELL_LOCAL <vof_phigrad[l=3]> "cellgrad[l=3](<vof_phi_lim>)" ON <all cells>
#CELL_LOCAL <vof_phigrad_mag^2> "dot(<vof_phigrad[l=:]>,<vof_phigrad[l=:]>)" ON <all cells>
#CELL_DERIVED <vof_phigrad_mag> "sqrt(cellmax(<vof_phigrad_mag^2>,1.d-20))" ON <all cells>
#<<dim1comment>>CELL_DERIVED <vof_phigrad_unit[l=1]> "<vof_phigrad[l=1]>/<vof_phigrad_mag>" ON <all cells> output
#<<dim2comment>>CELL_DERIVED <vof_phigrad_unit[l=2]> "<vof_phigrad[l=2]>/<vof_phigrad_mag>" ON <all cells>
#<<dim3comment>>CELL_DERIVED <vof_phigrad_unit[l=3]> "<vof_phigrad[l=3]>/<vof_phigrad_mag>" ON <all cells>

# 2d only averaging
CELL_DERIVED <vof_theta> "cellif(<vof_delta_mask>,atan2(<vof_phigrad[l=2]>,<vof_phigrad[l=1]>),0.d0)" ON <all cells> output
#CELL_DERIVED <vof_theta> "atan2(<cellx[l=2]>,<cellx[l=1]>)-<pi>" ON <all cells> output
#CELL_NEWTIENT <vof_theta[r=1]> "atan2(<cellx[l=2]>,<cellx[l=1]>)-<pi>" "<vof_theta_smoothed>" ON <all cells> output
CELL_TRANSIENT <vof_theta[r=1]> "atan2(<cellx[l=2]>,<cellx[l=1]>)-<pi>" "<vof_theta_smoothed>" ON <all cells> output
CELL_TRANSIENT <vof_theta_mask[r=1]> "1.d0" "<vof_theta_mask>" ON <all cells>
#CELL_TRANSIENT <vof_theta[r=1]> "0.d0" "<vof_theta_smoothed>" ON <all cells> output
CELL_TRANSIENT <vof_phigrad_theta_unit[l=1,r=1]> "cos(<vof_theta[r=1]>)" "<vof_phigrad_smoothed_unit[l=1]>" ON <all cells> output
CELL_TRANSIENT <vof_phigrad_theta_unit[l=2,r=1]> "sin(<vof_theta[r=1]>)" "<vof_phigrad_smoothed_unit[l=2]>" ON <all cells> output

CELL_LOCAL <vof_smooth_dist^2> "dot(<celltoseparationicellr[l=:]>,<celltoseparationicellr[l=:]>)"
CELL_CONSTANT <vof_smooth_eps_centre^2> "cellmin(cellmin(<celldxmin>,region=<adjacentcellicells>),2.d0*<celldxkernel>)**2" ON <all cells>
CELL_LOCAL <vof_smooth_eps^2> "cellfromcellave[separationcentre](<vof_smooth_eps_centre^2>)" ON <all cells>
NONE_CONSTANT <vof_theta_smoothing_constant> 0.5d0 # increased due to new exponential + sqrt smoothing function
CELL_LOCAL <vof_theta_smooth_kernel> "exp(-<vof_smooth_dist^2>/(<vof_smooth_eps^2>*<vof_theta_smoothing_constant>))"
CELL_DERIVED <vof_theta_smooth_denominator> "cellsum[maxseparation=3](cellif(<vof_delta_mask>,<vof_theta_smooth_kernel>*<vof_delta_mag>,0.d0),region=<all cells>)" ON <all cells> output
CELL_DERIVED <vof_theta_mask> "cellmax[maxseparation=3](<vof_delta_mask>,region=<all cells>)"

#CELL_LOCAL <vof_theta_relative_raw> "<vof_theta>-cellfromcellave[separationcentre](<vof_theta[r=1]>)"
CELL_LOCAL <vof_theta_relative_raw> "atan2(cellif(cellfromcellave[separationcentre](<cellx[l=2]>)+<celltoseparationicellr[l=2]>,1.d0,-1.d0)*sin(<vof_theta>),cellif(cellfromcellave[separationcentre](<cellx[l=1]>)+<celltoseparationicellr[l=1]>,1.d0,-1.d0)*cos(<vof_theta>))-cellfromcellave[separationcentre](<vof_theta[r=1]>)"
#CELL_LOCAL <vof_theta_relative_increment> "cellif(<vof_theta_relative_raw>-<pi>,-2.d0*<pi>,cellif(-(<vof_theta_relative_raw>+<pi>),2.d0*<pi>,0.d0))"
#CELL_LOCAL <vof_theta_relative> "<vof_theta_relative_raw>+<vof_theta_relative_increment>"
CELL_LOCAL <vof_theta_relative> "atan2(sin(<vof_theta_relative_raw>),cos(<vof_theta_relative_raw>))"
CELL_DERIVED <vof_theta_relative_smoothed> "cellif(<vof_theta_mask>,cellsum[maxseparation=3](cellif(<vof_delta_mask>,<vof_theta_relative>*<vof_theta_smooth_kernel>*<vof_delta_mag>,0.d0),region=<all cells>)/<vof_theta_smooth_denominator>,0.d0)" ON <all cells> output
CELL_LOCAL <vof_theta_smoothed_raw> "<vof_theta_relative_smoothed>+<vof_theta[r=1]>" ON <all cells> output
CELL_DERIVED <vof_theta_smoothed> "cellif(<vof_theta_mask>,atan2(sin(<vof_theta_smoothed_raw>),cos(<vof_theta_smoothed_raw>)),0.d0)"
<<dim1comment>>CELL_DERIVED <vof_phigrad_smoothed_unit[l=1]> "cellif(<vof_theta_mask>,cos(<vof_theta_smoothed>),0.d0)" ON <all cells> output
<<dim2comment>>CELL_DERIVED <vof_phigrad_smoothed_unit[l=2]> "cellif(<vof_theta_mask>,sin(<vof_theta_smoothed>),0.d0)" ON <all cells>
