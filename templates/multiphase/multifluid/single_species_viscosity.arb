MARKDOWN
Here we find <mu_f_species> for each species
END_MARKDOWN

REPLACEMENTS D "<<viscosity_method>>" W "einstein"

IF 1 # split viscosity between phases
  IF {{ return string_test('<<species>>','species0') }}
    CELL_DERIVED <mu_c_gradient_<<species>>> [Pa.s] "<mu_species0>" ON <allcells>
  ELSE
    CELL_DERIVED <mu_c_gradient_<<species>>> [Pa.s] "3.5d0*<mu_species0>" ON <allcells>
  END_IF
ELSE
  ERROR "no other viscosity coded up yet"
END_IF

# different functions specified through these correction factors
IF {{ return string_test('<<viscosity_method>>','thomas')}}
  IF {{ return string_test('<<species>>','species0') }}
    CELL_LOCAL <mu_c_gradient_<<species>>> "<mu_c_gradient_<<species>>>"
  ELSE
    ERROR "thomas method not done"
#   CELL_LOCAL <mu_correction_<<species>>> "10.05d0*<phi_bounded_<<species>>>+0.00273d0*exp(16.6d0*<phi_bounded_<<species>>>)/<phi_lim_<<species>>>"
  END_IF
END_IF

CELL_LOCAL <mu_c_<<species>>> "<mu_c_gradient_<<species>>>*<phi_bounded_<<species>>>" ON <allcells>
FACE_DERIVED <mu_f_<<species>>> "faceave[harmonic](<mu_c_<<species>>>)" ON <allfaces> # used in stress
FACE_DERIVED <mu_f_gradient_<<species>>> "faceave[adjacentcells](<mu_c_gradient_<<species>>>)" ON <allfaces> # used in rhie-chow

#Define normal viscosity (Morris & Boulay 1999)
INCLUDE "mixture_viscosity"  R "<mu_n_l>" W "<mu_species0>" R "<mu" W "<mu_n" R "<<mumixturequemada>>" W "0" R "<<mumixturemb1999>>" W "0" R "<<munormalmb1999>>" W "1" R "phi_total_species" W "phi_species1"
FACE_DERIVED <mu_n_f> "faceave[harmonic](<mu_n>)" ON <allfaces>
