# first set up some constants relating to the discretisation

# phi fraction below which (for either phase) indicates that we aren't in an interface cell 
# there is a default value for this set in free_surface_functions.f90 (phitol_default) which will be used in the vof-specific functions if this is not passed to them explicitly
CONSTANT <vof_phi_tol> 1.d-8
# convert this to a single tolerance on the gradient of phi also, using the average celldxmax within the domain
NONE_CONSTANT <celldxave> "cellsum(<celldxmax>,region=<domain>)/cellsum(1.d0,region=<domain>)" # average cell dimension, exactly the same as defined in navier_stokes files
NONE_CONSTANT <vof_phigrad_tol> "<vof_phi_tol>/<celldxave>" # use this as a standard phigrad tolerance

# this is the vof function, defined on all cells
CELL_UNKNOWN <vof_phi> [] "<vof_phi_initial>" ON <all cells> magnitude=1.d0
#CELL_LOCAL <vof_phi_lim> "cellmax(cellmin(<vof_phi>,1.d0),0.d0)"
# now this is a derived, so that newtstepmax can be used with it to turn off implicit iterations if newton loop is not converging
CELL_DERIVED <vof_phi_lim> "cellmax(cellmin(<vof_phi>,1.d0),0.d0)" ON <all cells> newtstepmax=20
# and so is this, which is the <vof_phi> used in the curvature/force calculation
CELL_DERIVED <vof_phi_interface> "<vof_phi>" ON <all cells> newtstepmax=10
# update vof, while rounding to identify interface cells
CELL_LOCAL <vof_phi_rounded> "cellif(<vof_phi>-<vof_phi_tol>,cellif(1.d0-<vof_phi_tol>-<vof_phi>,<vof_phi>,1.d0),0.d0)"
CELL_TRANSIENT <vof_phi[r=1]> "<vof_phi_rounded>" "<vof_phi_rounded>" ON <all cells> nooutput
# update without rounding
#CELL_TRANSIENT <vof_phi[r=1]> "<vof_phi>" "<vof_phi>" ON <all cells> nooutput

CELL_LOCAL <vof_phi_initial> "0.d0" # default initial phi value - set this to something in the actual input file

# also define a mask that may be required in smoothing routines that defines which cells are interface cells or not
# should think more carefully about <vof_phi_tol> here
#CELL_LOCAL <vof_interface_mask> "cellif(cellmax(<vof_phi_lim>,region=<adjacentcellicells>)-cellmin(<vof_phi_lim>,region=<adjacentcellicells>)-<vof_phi_tol>,1.d0,0.d0)" ON <all cells>
# now make this a derived and limit variation to newtstepmax=3 - for CFL < 1 there is a bit of slack in this mask which should mean that this doesn't matter
#CELL_DERIVED <vof_interface_mask> "cellif(cellmax(<vof_phi_lim>,region=<adjacentcellicells>)-cellmin(<vof_phi_lim>,region=<adjacentcellicells>)-<vof_phi_tol>,1.d0,0.d0)" ON <all cells> newtstepmax=3
CELL_TRANSIENT <vof_interface_mask> "" "cellif(cellmax(<vof_phi_lim>,region=<adjacentcellicells>)-cellmin(<vof_phi_lim>,region=<adjacentcellicells>)-<vof_phi_tol>,1.d0,0.d0)" ON <all cells>
