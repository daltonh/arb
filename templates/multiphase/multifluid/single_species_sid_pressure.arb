REPLACEMENTS D "<<anisotropic>>" W "0"
REPLACEMENTS D "<<highPeSID>>" W "1" D "<<lowPeSID>>" W "0"

#Calculate solid pressure due to shear induced diffusion
NONE_CONSTANT <c_sid> "1.d0/9.d0"
INCLUDE_TEMPLATE "navier_stokes/"
INCLUDE "strain_rate_magnitude" R "ugrad_" W "ugrad_<<species>>_" R "gamma" W "gamma_<<species>>" R "u_f_vect" W "u_f_vect_<<species>>" R "u[" W "u_<<species>>["
VARIABLE <gamma_<<species>>_magnitude> output

INCLUDE_TEMPLATE "multiphase/multifluid"
  #Define normal viscosity (Morris & Boulay 1999)
  # moved from single_species_viscosity
  INCLUDE "mixture_viscosity"  R "<mu_<<species>>_n_l>" W "<mu_species0>" R "<mu" W "<mu_<<species>>_n" R "<<mumixturequemada>>" W "0" R "<<mumixturemb1999>>" W "0" R "<<munormalmb1999>>" W "1" R "phi_total_species" W "phi_<<species>>"
  FACE_DERIVED <mu_<<species>>_n_f> "faceave[harmonic](<mu_<<species>>_n>)" ON <allfaces>

  CELL_DERIVED <Pe_local_<<species>>> "6*pi*<mu_species0>*<gamma_<<species>>_magnitude>*<a_<<species>>>**3/(<k_boltzmann>*<T>)"

#Calculate shear induced pressure here (Infinite Pe SID, Morris & Boulay J. Rheo. 1999)
  IF <<highPeSID>>
    #CELL_LOCAL <p_sid_multiplier_<<species>>_highPe> "<gamma_<<species>>_magnitude>*<mu_<<species>>_n>" ON <allcells> output
    CELL_LOCAL <p_sid_multiplier_<<species>>_highPe> "<c_sid>*<gamma_allphases_magnitude>*<mu_c_allsolids>*<p_osmotic_Z_allsolids>" ON <allcells> output
    #CELL_LOCAL <p_sid_multiplier_<<species>>_highPe> "<gamma_<<species>>_magnitude>*<mu_c_allsolids>*<p_osmotic_Z_allsolids>" ON <allcells> output
  END_IF

  IF <<lowPeSID>>
      NONE_CONSTANT <A_sid> "0.4d0"

      INCLUDE "mixture_viscosity_concentrated" R "phi_total_species" W "phi_<<species>>" R "<mu" W "<p_lowPeSID_func" R "<mu_l>" W "1.0d0" R "<<variable>>" W "(cellmin(<phi_total_species>,<mu_phi_total_species_cutoff>))" R "<<function>>" W "<<variable>>/(1.-<<variable>>/<mu_phi_total_species_max>)^3" R "<<cutoff_variable>>" W "<mu_phi_total_species_cutoff>" R "<<cutoff_function>>" W "<<cutoff_variable>>/(1.-<<cutoff_variable>>/<mu_phi_total_species_max>)^3"

      CELL_LOCAL <p_sid_multiplier_<<species>>_lowPe> "<mu_species0>*<gamma_<<species>>_magnitude>*<A_sid>*<Pe_local_<<species>>>*<p_lowPeSID_func>" output
  END_IF

  #Blended SID function (Frank et al. 2003 JFM to account for finite Pe effects)
  CELL_LOCAL <p_sid_multiplier_<<species>>> "0.0d0"  output
  IF <<highPeSID>>
    IF <<lowPeSID>>
      VARIABLE <p_sid_multiplier_<<species>>> "<p_sid_multiplier_<<species>>_highPe>*<p_sid_multiplier_<<species>>_lowPe>/(<p_sid_multiplier_<<species>>_highPe>+<p_sid_multiplier_<<species>>_lowPe>+<tiny>)"
    ELSE
      VARIABLE <p_sid_multiplier_<<species>>> "<p_sid_multiplier_<<species>>_highPe>"
    END_IF
  ELSE_IF <<lowPeSID>>
    VARIABLE <p_sid_multiplier_<<species>>> "<p_sid_multiplier_<<species>>_lowPe>"
  ELSE
    ERROR "Inconsistent specification of shear-induced diffusion in particle_stress.arb"

  END_IF

CELL_LOCAL <p_sid_<<species>>> "<p_sid_multiplier_<<species>>>*<phi_<<species>>>" ON <allcells> # note that phi here isn't limited so that negative osmotic pressures could be generated at boundaries where phi goes negative


  CELL_OUTPUT <M_sid_<<species>>[l=1]> "-celldivgrad[l=1](<p_sid_<<species>>>)" ON <allcells>
  CELL_OUTPUT <M_sid_<<species>>[l=2]> "-celldivgrad[l=2](<p_sid_<<species>>>)" ON <allcells>
  <<dim3comment>> CELL_OUTPUT <M_sid_<<species>>[l=3]> "-celldivgrad[l=3](<p_sid_<<species>>>)" ON <allcells>
  FACE_OUTPUT <M_sid_<<species>>_f[l=1]> "-facegrad[l=1](<p_sid_<<species>>>)" ON <allfaces>
  FACE_OUTPUT <M_sid_<<species>>_f[l=2]> "-facegrad[l=2](<p_sid_<<species>>>)" ON <allfaces>
  <<dim3comment>> FACE_OUTPUT <M_sid_<<species>>_f[l=3]> "-facegrad[l=3](<p_sid_<<species>>>)" ON <allfaces>
