MARKDOWN
#Faxen Drag Equation Template
END_MARKDOWN

REPLACEMENTS D "<<faxen_method>>" W "version2"
#IF {{ return ( string_test("<<stress_method>>","version4") || string_test("<<stress_method>>","version4_species")) }} # for these methods switch to faxen method version3
#  REPLACEMENTS S "<<faxen_method>>" W "version3"
#END_IF

IF {{ return string_test('<<faxen_method>>','version1') }}

# Calculating the laplacian of velocity = divergence of strain rate tensor
  CELL_DERIVED <laplacian_species0[l=<<i>>]> "celldiv(dot(<facenorm[l=:]>,<ugrad_f_species0[l=:,<<i>>]>))" ON <domain> output

  IF 0 #Mctigue
    CELL_DERIVED <particle_force_alpha4> "7/2*<mu_species0>" ON <domain> output
  ELSE #Zhang and Prosperiti (Dalton)
    CELL_DERIVED <particle_force_alpha4> "3/4*<mu_species0>" ON <domain> output
  END_IF

  CELL_DERIVED <particle_force_faxen_<<species>>[l=<<i>>]> "-<particle_force_alpha4>*<laplacian_species0[l=<<i>>]>" ON <domain> output # right sign??

ELSE_IF {{ return string_test('<<faxen_method>>','version2') }}

  CELL_DERIVED <laplacian_species0[l=<<i>>]> "celldiv(dot(<facenorm[l=:]>,<ugrad_f_species0[l=:,<<i>>]>))" ON <domain> output

# include the influence of hindered settling function etc
  CELL_DERIVED <particle_force_faxen_<<species>>[l=<<i>>]> "<beta^_<<species>>_species0>*(<a_<<species>>>**2)*<laplacian_species0[l=<<i>>]>/6.d0" ON <domain> output

ELSE_IF {{ return string_test('<<faxen_method>>','version3') }} # this is for version4 equations

  IF {{ return ( string_test("<<stress_method>>","version4") ) }}
    CELL_DERIVED <laplacian_mixture[l=<<i>>]> "celldiv(dot(<facenorm[l=:]>,<gamma_f_mixture[l=:,<<i>>]>))" ON <domain> output
  # include the influence of hindered settling function etc
    CELL_DERIVED <particle_force_faxen_<<species>>[l=<<i>>]> "(7.d0/4.d0)*<mu_species0>*<laplacian_mixture[l=<<i>>]>" ON <domain> output
  ELSE_IF {{ return ( string_test("<<stress_method>>","version4_species") ) }}
    CELL_DERIVED <laplacian_species0[l=<<i>>]> "celldiv(dot(<facenorm[l=:]>,<gamma_f_species0[l=:,<<i>>]>))" ON <domain> output
  # include the influence of hindered settling function etc
    CELL_DERIVED <particle_force_faxen_<<species>>[l=<<i>>]> "(7.d0/4.d0)*<mu_species0>*<laplacian_species0[l=<<i>>]>" ON <domain> output
  ELSE
    ERROR "must be using stress_method = version4 for faxen_method = version3 in single_species_faxen template"
  END_IF

END_IF

# finally add these contributions onto extra force
# a positive contribution to the solid species
VARIABLE <extra_force_<<species>>[l=<<i>>]> "<extra_force_<<species>>[l=<<i>>]> + <particle_force_faxen_<<species>>[l=<<i>>]>"
# and an opposite contribution to the fluid species, specific to volume fraction
VARIABLE <extra_force_species0[l=<<i>>]> "<extra_force_species0[l=<<i>>]> - <particle_force_faxen_<<species>>[l=<<i>>]>*<phi_bounded_<<species>>>/<phi_bounded_species0>"

# output on force
VARIABLE <particle_force_faxen_<<species>>[l=<<i>>]> output
